<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImageLabel Admin Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header { background: #2196F3; color: white; padding: 20px; text-align: center; border-radius: 8px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stat-card { background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-number { font-size: 2em; font-weight: bold; color: #1976D2; }
        .transactions { margin-top: 20px; }
        .transaction { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .pending { border-left: 4px solid #ff9800; }
        .approved { border-left: 4px solid #4caf50; }
        .rejected { border-left: 4px solid #f44336; }
        .btn { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-approve { background: #4caf50; color: white; }
        .btn-reject { background: #f44336; color: white; }
        .btn:hover { opacity: 0.8; }
        .users-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .users-table th, .users-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .users-table th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ†Ô∏è ImageLabel Admin Dashboard</h1>
            <p>Manage payments, users, and transactions</p>
        </div>

        <div class="card">
            <h2>üìä System Statistics</h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-users">-</div>
                    <div>Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-transactions">-</div>
                    <div>Total Transactions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-transactions">-</div>
                    <div>Pending Payments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-images">-</div>
                    <div>Total Images</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üí≥ Pending Transactions</h2>
            <div id="transactions-list">
                <p>Loading transactions...</p>
            </div>
        </div>

        <div class="card">
            <h2>üë• All Users</h2>
            <table class="users-table" id="users-table">
                <thead>
                    <tr>
                        <th>Device ID</th>
                        <th>Credits</th>
                        <th>Free Photos</th>
                        <th>Total Photos</th>
                        <th>Last Active</th>
                    </tr>
                </thead>
                <tbody id="users-body">
                    <tr><td colspan="5">Loading users...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';

        // Load dashboard data
        async function loadDashboard() {
            try {
                // Load health stats
                const healthResponse = await fetch(`${API_BASE}/health`);
                const health = await healthResponse.json();
                
                document.getElementById('total-users').textContent = health.data.total_users;
                document.getElementById('total-transactions').textContent = health.data.total_transactions;
                document.getElementById('total-images').textContent = health.data.total_images;

                // Load transactions
                await loadTransactions();
                
                // Load users
                await loadUsers();
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadTransactions() {
            try {
                const response = await fetch(`${API_BASE}/admin/transactions`);
                const result = await response.json();
                const transactions = result.data || [];

                const pendingCount = transactions.filter(t => t.status === 'pending').length;
                document.getElementById('pending-transactions').textContent = pendingCount;

                const transactionsList = document.getElementById('transactions-list');
                
                if (transactions.length === 0) {
                    transactionsList.innerHTML = '<p>No transactions found.</p>';
                    return;
                }

                transactionsList.innerHTML = transactions
                    .filter(t => t.status === 'pending')
                    .map(tx => `
                        <div class="transaction ${tx.status}">
                            <h4>Transaction ${tx.id}</h4>
                            <p><strong>Device:</strong> ${tx.device_id}</p>
                            <p><strong>Amount:</strong> ${tx.amount} MMK</p>
                            <p><strong>Credits:</strong> ${tx.credits} photos</p>
                            <p><strong>Method:</strong> ${tx.payment_method}</p>
                            <p><strong>Transaction ID:</strong> ${tx.transaction_id}</p>
                            <p><strong>Date:</strong> ${new Date(tx.created_at).toLocaleString()}</p>
                            <p><strong>Status:</strong> ${tx.status}</p>
                            ${tx.status === 'pending' ? `
                                <button class="btn btn-approve" onclick="approveTransaction('${tx.id}')">‚úÖ Approve</button>
                                <button class="btn btn-reject" onclick="rejectTransaction('${tx.id}')">‚ùå Reject</button>
                            ` : ''}
                        </div>
                    `).join('');
            } catch (error) {
                console.error('Error loading transactions:', error);
                document.getElementById('transactions-list').innerHTML = '<p>Error loading transactions.</p>';
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/admin/users`);
                const result = await response.json();
                const users = result.data || [];

                const usersBody = document.getElementById('users-body');
                
                if (users.length === 0) {
                    usersBody.innerHTML = '<tr><td colspan="5">No users found.</td></tr>';
                    return;
                }

                usersBody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.device_id}</td>
                        <td>${user.credits}</td>
                        <td>${user.free_photos}</td>
                        <td>${user.total_photos}</td>
                        <td>${new Date(user.last_active_at).toLocaleString()}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('users-body').innerHTML = '<tr><td colspan="5">Error loading users.</td></tr>';
            }
        }

        async function approveTransaction(txId) {
            try {
                const response = await fetch(`${API_BASE}/admin/transactions/${txId}/approve`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('Transaction approved successfully!');
                    await loadDashboard(); // Reload data
                } else {
                    alert('Error approving transaction');
                }
            } catch (error) {
                console.error('Error approving transaction:', error);
                alert('Error approving transaction');
            }
        }

        async function rejectTransaction(txId) {
            try {
                const response = await fetch(`${API_BASE}/admin/transactions/${txId}/reject`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('Transaction rejected!');
                    await loadDashboard(); // Reload data
                } else {
                    alert('Error rejecting transaction');
                }
            } catch (error) {
                console.error('Error rejecting transaction:', error);
                alert('Error rejecting transaction');
            }
        }

        // Load dashboard on page load
        window.addEventListener('DOMContentLoaded', loadDashboard);

        // Auto-refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
